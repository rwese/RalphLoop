#!/usr/bin/env bash
# RalphLoop Husky Setup Hook
# This hook runs on commit messages to ensure husky is properly set up
#
# Install husky hooks by running: npx husky install
# Or manually copy these hooks to .git/hooks/

set -e -u -o pipefail

HUSKY_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$HUSKY_DIR/../.." && pwd)"
GIT_HOOKS_DIR="$PROJECT_ROOT/.git/hooks"

# Ensure husky hooks are executable
ensure_hooks_executable() {
    local hook
    for hook in "$HUSKY_DIR"/*; do
        if [ -f "$hook" ]; then
            chmod +x "$hook" 2>/dev/null || true
        fi
    done
}

# Install husky if not already installed
install_husky() {
    if [ ! -d "$PROJECT_ROOT/node_modules/.bin/husky" ]; then
        if [ -f "$PROJECT_ROOT/package.json" ]; then
            echo "Installing husky..."
            npm install --save-dev husky 2>/dev/null || true
        fi
    fi
}

# Main setup
main() {
    # Ensure hooks are executable
    ensure_hooks_executable

    # Try to install husky if available
    install_husky

    # Exit successfully (this hook just sets up husky)
    exit 0
}

main
