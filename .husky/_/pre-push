#!/usr/bin/env bash
# RalphLoop Pre-Push Hook
# Runs tests before allowing code to be pushed to the remote repository
#
# This hook is automatically installed by the prepare-commit-msg hook setup.
# To manually install: cp .husky/_/pre-push .git/hooks/pre-push

set -e -u -o pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
HUSKY_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$HUSKY_DIR/../.." && pwd)"
TEST_SCRIPT="$PROJECT_ROOT/tests/run-tests.sh"

# Print functions
print_header() {
    echo ""
    echo -e "${CYAN}========================================${NC}"
    echo -e "${CYAN}$1${NC}"
    echo -e "${CYAN}========================================${NC}"
}

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_pass() {
    echo -e "${GREEN}✓ PASS${NC} $1"
}

print_fail() {
    echo -e "${RED}✗ FAIL${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠️  WARNING${NC} $1"
}

# Check if test script exists
check_test_script() {
    if [ ! -f "$TEST_SCRIPT" ]; then
        print_warning "Test script not found at: $TEST_SCRIPT"
        print_warning "Skipping pre-push tests..."
        return 0
    fi
    chmod +x "$TEST_SCRIPT" 2>/dev/null || true
}

# Run quick tests
run_quick_tests() {
    print_info "Running quick tests before push..."

    local start_time=$(date +%s)
    local output
    local exit_code=0

    output=$("$TEST_SCRIPT" --quick --ci 2>&1) || exit_code=$?

    local end_time=$(date +%s)
    local duration=$((end_time - start_time))

    echo "$output"

    if [ $exit_code -eq 0 ]; then
        print_pass "Quick tests passed in ${duration}s"
        return 0
    else
        print_fail "Quick tests failed in ${duration}s"
        echo ""
        echo -e "${RED}❌ Push rejected due to test failures${NC}"
        echo ""
        echo "To fix this issue:"
        echo "  1. Run tests locally: ./tests/run-tests.sh --all"
        echo "  2. Fix any failing tests"
        echo "  3. Commit the fixes"
        echo "  4. Try pushing again"
        return 1
    fi
}

# Run lint checks
run_lint_checks() {
    print_info "Running lint checks..."

    # Check for shellcheck
    if command -v shellcheck &> /dev/null; then
        print_info "Checking shell scripts with shellcheck..."

        local lint_failed=0

        # Check main scripts
        for script in "$PROJECT_ROOT/ralph" "$PROJECT_ROOT/tests/run-tests.sh" "$PROJECT_ROOT/backends/mock/bin/mock-opencode"; do
            if [ -f "$script" ] && [ -x "$script" ]; then
                local lint_output
                local lint_exit=0
                lint_output=$(shellcheck -x "$script" 2>&1) || lint_exit=$?

                # Only fail on actual errors, not style warnings
                if echo "$lint_output" | grep -qE "^[^[:space:]]+\.sh:.*error"; then
                    print_fail "Lint errors found in $script"
                    echo "$lint_output" | grep -E "^[^[:space:]]+\.sh:.*error" | head -5
                    lint_failed=1
                fi
            fi
        done

        if [ $lint_failed -eq 1 ]; then
            print_fail "Lint checks failed"
            return 1
        fi
        print_pass "Lint checks passed"
    else
        print_info "shellcheck not installed, skipping lint checks"
    fi

    return 0
}

# Main function
main() {
    print_header "RalphLoop Pre-Push Checks"

    echo "Branch: $(git rev-parse --abbrev-ref HEAD)"
    echo "Remote: ${1:-not specified}"
    echo ""

    # Check for test script
    check_test_script || return 1

    # Run lint checks first (faster)
    run_lint_checks || return 1

    # Run quick tests
    run_quick_tests || return 1

    print_header "Pre-Push Checks Complete"
    echo -e "${GREEN}✅ All checks passed! Ready to push.${NC}"
    echo ""

    return 0
}

# Run main
main "$@"
