#!/usr/bin/env bash

# bin/ralph - RalphLoop entry point
# Main script that sources lib.sh and runs the execution pipeline
#
# Purpose:
#   Primary entry point for RalphLoop autonomous development system.
#   Initializes the library modules and delegates to the pipeline executor.
#
# Usage:
#   ./ralph [options] [iterations]
#   ./ralph pipeline <command> [options]
#
# Options:
#   --sessions [--dir <path>]  List sessions (optionally filter by directory)
#   --resume <id>              Resume a specific session
#   --cleanup [days]           Clean up incomplete sessions older than N days
#   --cleanup-all              Clean up ALL incomplete sessions
#   --dir <path>               Filter sessions by directory
#   --force-resume             Force resume without prompting
#   -h, --help                 Show help message
#
# Pipeline Commands:
#   pipeline run         Run the configured pipeline
#   pipeline resume      Resume interrupted pipeline
#   pipeline validate    Validate pipeline configuration
#   pipeline status      Show current pipeline status
#   pipeline reset       Reset pipeline state
#   pipeline stop        Emergency stop (if running)
#
# Related Files:
#   lib.sh: Unified library loader
#   lib/pipeline.sh: Pipeline execution functions
#   lib/args.sh: Argument parsing functions

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Set the lib directory for sourcing
LIB_DIR="${SCRIPT_DIR}/../lib"

# Ensure proper error handling
set -e -u -o pipefail

# =============================================================================
# Initialize Library
# =============================================================================

# Source the unified library loader
source "${SCRIPT_DIR}/../lib.sh"

# =============================================================================
# Custom Command Configuration
# =============================================================================

# Custom command configuration
# Environment variables for custom execution modes
RALPH_COMMAND="${RALPH_COMMAND:-}"
RALPH_BACKEND="${RALPH_BACKEND:-}"
RALPH_MODE="${RALPH_MODE:-autonomous}"

# Handle custom command mode
# Executes a custom command with the configured backend and mode.
#
# Purpose:
#   Supports alternative execution modes beyond the standard pipeline.
#   Used for custom workflows and testing scenarios.
#
# Environment Variables:
#   RALPH_COMMAND: Custom command to execute
#   RALPH_BACKEND: Backend to use
#   RALPH_MODE: Execution mode (autonomous, interactive, validation)
#
# Example:
#   RALPH_COMMAND="test" RALPH_BACKEND=mock ./bin/ralph
handle_custom_command() {
    if [[ -n "$RALPH_COMMAND" ]]; then
        echo "========================================"
        echo "ðŸ”§ Custom Command Mode: $RALPH_COMMAND"
        echo "========================================"
        echo "  Backend: ${RALPH_BACKEND:-default}"
        echo "  Mode: $RALPH_MODE"
        echo "========================================"

        # Export backend and mode for the agent
        export RALPH_BACKEND="$RALPH_BACKEND"
        export RALPH_MODE="$RALPH_MODE"
    fi
}

# =============================================================================
# Main Entry Point
# =============================================================================

# Initialize custom command support
handle_custom_command

# Parse command-line arguments
parse_cli_args "$@"
shift $#

# Handle session management commands before main execution
handle_session_commands

# For cleanup commands, exit early (handle_session_commands handles --cleanup)
if [ -n "$RALPH_CLEANUP" ]; then
    exit 0
fi

# Handle pipeline commands (exit after handling)
handle_pipeline_commands

# Set MAX_ROUNDS from remaining positional parameters (iteration count)
if [ $# -gt 0 ]; then
    MAX_ROUNDS="$1"
fi

# Ensure progress file exists
if [ ! -f "$PROGRESS_FILE" ]; then
    touch "$PROGRESS_FILE"
fi

# Run the main execution if not in special command mode
if [ -z "$RALPH_COMMAND" ]; then
    # Use the new pipeline-based execution
    run_pipeline
fi
