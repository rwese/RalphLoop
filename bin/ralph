#!/usr/bin/env bash

# bin/ralph - RalphLoop entry point
# Main script that sources lib.sh and runs the execution loop

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Set the lib directory for sourcing
LIB_DIR="${SCRIPT_DIR}/../lib"

# Ensure proper error handling
set -e -u -o pipefail

# =============================================================================
# Initialize Library
# =============================================================================

# Source the unified library loader
source "${SCRIPT_DIR}/../lib.sh"

# =============================================================================
# Custom Command Configuration
# =============================================================================

# Custom command configuration
RALPH_COMMAND="${RALPH_COMMAND:-}"
RALPH_BACKEND="${RALPH_BACKEND:-}"
RALPH_MODE="${RALPH_MODE:-autonomous}"

# Handle custom command mode
handle_custom_command() {
    if [[ -n "$RALPH_COMMAND" ]]; then
        echo "========================================"
        echo "ðŸ”§ Custom Command Mode: $RALPH_COMMAND"
        echo "========================================"
        echo "  Backend: ${RALPH_BACKEND:-default}"
        echo "  Mode: $RALPH_MODE"
        echo "========================================"

        # Export backend and mode for the agent
        export RALPH_BACKEND="$RALPH_BACKEND"
        export RALPH_MODE="$RALPH_MODE"
    fi
}

# =============================================================================
# Main Entry Point
# =============================================================================

# Initialize custom command support
handle_custom_command

# Parse command-line arguments
parse_cli_args "$@"
shift $#

# Handle session management commands before main execution
handle_session_commands

# For cleanup commands, exit early (handle_session_commands handles --cleanup)
if [ -n "$RALPH_CLEANUP" ]; then
    exit 0
fi

# Handle pipeline commands (exit after handling)
handle_pipeline_commands

# Set MAX_ROUNDS from remaining positional parameters (iteration count)
if [ $# -gt 0 ]; then
    MAX_ROUNDS="$1"
fi

# Ensure progress file exists
if [ ! -f "$PROGRESS_FILE" ]; then
    touch "$PROGRESS_FILE"
fi

# Run the main execution if not in special command mode
if [ -z "$RALPH_COMMAND" ]; then
    run_main_loop
fi
