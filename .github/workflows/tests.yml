name: RalphLoop Tests

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  schedule:
    # Run weekly tests on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'

env:
  # Test configuration
  TEST_TYPE: all
  RALPH_MOCK_RESPONSE: success
  RALPH_MOCK_DELAY: 0
  RALPH_MOCK_EXIT_CODE: 0

jobs:
  # ==========================================================================
  # Quick Tests - Runs on every push
  # ==========================================================================
  quick-tests:
    name: Quick Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup bash
        run: |
          echo "Shell: bash" >> $GITHUB_ENV
          echo "Shell version: $(bash --version | head -1)"

      - name: Make test script executable
        run: chmod +x tests/run-tests.sh

      - name: Run quick tests
        run: |
          echo "Running quick tests..."
          ./tests/run-tests.sh --quick --ci

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quick-test-results
          path: test-results/
          retention-days: 7

  # ==========================================================================
  # Unit Tests - Runs on every push and PR
  # ==========================================================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: quick-tests
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup bash
        run: chmod +x tests/run-tests.sh

      - name: Run unit tests
        run: |
          echo "Running unit tests..."
          ./tests/run-tests.sh --unit --ci

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: test-results/
          retention-days: 7

  # ==========================================================================
  # Mock Backend Tests - Runs on every push and PR
  # ==========================================================================
  mock-tests:
    name: Mock Backend Tests
    runs-on: ubuntu-latest
    needs: quick-tests
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup bash
        run: chmod +x tests/run-tests.sh

      - name: Run mock backend tests
        run: |
          echo "Running mock backend tests..."
          ./tests/run-tests.sh --mock --ci

      - name: Upload mock test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mock-test-results
          path: test-results/
          retention-days: 7

  # ==========================================================================
  # Integration Tests - Runs on PR and main branch
  # ==========================================================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, mock-tests]
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup bash
        run: chmod +x tests/run-tests.sh

      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          ./tests/run-tests.sh --integration --ci

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: test-results/
          retention-days: 7

  # ==========================================================================
  # End-to-End Tests - Runs on PR and main branch
  # ==========================================================================
  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup bash
        run: chmod +x tests/run-tests.sh

      - name: Run E2E tests
        run: |
          echo "Running end-to-end tests..."
          ./tests/run-tests.sh --e2e --ci

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/
          retention-days: 7

  # ==========================================================================
  # Full Test Suite - Runs on merge to main and scheduled
  # ==========================================================================
  full-test-suite:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: e2e-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup bash
        run: chmod +x tests/run-tests.sh

      - name: Run all tests
        run: |
          echo "Running full test suite..."
          ./tests/run-tests.sh --all --ci

      - name: Upload full test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: full-test-results
          path: test-results/
          retention-days: 30

      - name: Create test summary
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All tests passed! âœ“" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Quick Tests: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Unit Tests: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Mock Backend Tests: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- Integration Tests: Passed" >> $GITHUB_STEP_SUMMARY
          echo "- E2E Tests: Passed" >> $GITHUB_STEP_SUMMARY

  # ==========================================================================
  # Performance Tests - Runs weekly
  # ==========================================================================
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: full-test-suite
    if: github.event_name == 'schedule'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup bash
        run: chmod +x tests/run-tests.sh

      - name: Run performance tests
        run: |
          echo "Running performance tests..."
          # Test with various delays and scenarios
          echo "Test 1: Zero delay"
          RALPH_MOCK_DELAY=0 ./tests/run-tests.sh --quick --ci

          echo "Test 2: Short delay"
          RALPH_MOCK_DELAY=1 ./tests/run-tests.sh --quick --ci

          echo "Test 3: Multiple iterations"
          RALPH_MOCK_DELAY=0 ./tests/run-tests.sh --e2e --ci

      - name: Upload performance results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-test-results
          path: test-results/
          retention-days: 30
