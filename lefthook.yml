# lefthook.yml - Git hooks configuration for RalphLoop
#
# SECURITY: Do NOT use `git commit --no-verify` or `git commit -n`
# Pre-commit hooks MUST run to catch secrets before they reach CI.
# Skipping hooks will allow exposed secrets in the codebase.
# If you must bypass hooks, you are violating security policy.

pre-push:
  parallel: false
  commands:
    # Run quick tests before push - REJECTS push if tests fail
    # This ensures code quality is maintained before reaching CI
    quick-tests:
      run: ./tests/run-tests.sh --quick --ci
      description: Running quick tests before push
      exit-code: 1  # FAIL push if tests fail

    # Lint all shell scripts in the project
    # Using 'run' without 'glob' to run unconditionally
    shell-lint-all:
      run: npx shellcheck ralph tests/**/*.sh backends/mock/bin/mock-opencode 2>&1 | grep -E "^(.*\.sh:.*error)" || true
      description: Linting all shell scripts
      exit-code: 1  # FAIL push if critical lint errors found

pre-commit:
  parallel: false
  commands:
    # Secret scanning - CRITICAL: This MUST pass
    # NEVER skip this check with --no-verify
    secrets-scan:
      run: gitleaks protect --staged --verbose --exit-code=1
      description: Scanning for secrets in staged changes

    # Lint only staged shell scripts
    # Using 'run' without 'glob' to run unconditionally
    shell-lint-staged:
      glob: '*.sh'
      run: npx shellcheck {staged_files} 2>&1 | grep -E "^(.*\.sh:.*error)" || true
      description: Linting staged shell scripts
      exit-code: 1  # FAIL commit if critical lint errors found

  # Formatting and linting (run after secrets scan)
  hooks:
    - name: format
      run: npx prettier --write {staged_files}
      stage: true
    - name: format-jsonc
      glob: '*.jsonc'
      run: npx prettier --write --parser jsonc {staged_files}
      stage: true
    - name: lint-markdown
      glob: '*.md'
      run: npx markdownlint --fix --config .markdownlintrc.json {staged_files}
      stage: true
