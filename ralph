#!/usr/bin/env bash

# ralph - RalphLoop Autonomous Development Agent
# Usage: ./ralph <iterations>
#
# Prompt can be provided via:
# 1. prompt.md file (default)
# 2. RALPH_PROMPT environment variable (direct prompt text)
# 3. RALPH_PROMPT_FILE environment variable (path to prompt file)
#
# Custom commands can trigger evaluation loops via:
# - RALPH_COMMAND: Execute a specific command mode
# - RALPH_BACKEND: Use a specific backend configuration
# - RALPH_MODE: Set evaluation mode (autonomous, interactive, validation)
#
# Supported custom commands:
#   ralf-trigger --iterations N --mode MODE --backend BACKEND
#   ralf-status [--progress] [--state] [--backends]
#   ralf-config [--get key] [--set key=value] [--list]
#
# Environment variables:
#   RALPH_TIMEOUT       - Timeout for opencode commands in seconds (default: 600 = 10 minutes)
#   RALPH_MEMORY_LIMIT  - Memory limit in KB (default: 2097152 = 2GB)
#   RALPH_LOG_LEVEL     - OpenCode log level: DEBUG, INFO, WARN, ERROR (default: WARN)
#   RALPH_PRINT_LOGS    - Print opencode logs to stderr: true/false (default: false)
#   RALPH_PROMPT        - Direct prompt text
#   RALPH_PROMPT_FILE   - Path to prompt file
#   RALPH_COMMAND       - Custom command to execute
#   RALPH_BACKEND       - Backend to use
#   RALPH_MODE          - Mode: autonomous, interactive, validation

set -e -u -o pipefail

# Configuration
MAX_ROUNDS=${1:-100}
PROGRESS_FILE="progress.md"
PROMPT_FILE="prompt.md"
VALIDATION_ISSUES_FILE=".ralph_validation_issues.txt"
BACKENDS_DIR="backends"

# Timeout and memory configuration (customizable via environment)
RALPH_TIMEOUT=${RALPH_TIMEOUT:-600}        # Default: 10 minutes in seconds
RALPH_MEMORY_LIMIT=${RALPH_MEMORY_LIMIT:-2097152}  # Default: 2GB in KB

# OpenCode logging configuration
RALPH_LOG_LEVEL=${RALPH_LOG_LEVEL:-WARN}   # Default: WARN to avoid too much output
RALPH_PRINT_LOGS=${RALPH_PRINT_LOGS:-false}  # Default: false (logs to file instead)

# Build opencode command with logging options
OPENCOD_OPTS=""
if [ -n "$RALPH_LOG_LEVEL" ]; then
  OPENCOD_OPTS="$OPENCOD_OPTS --log-level $RALPH_LOG_LEVEL"
fi
if [ "$RALPH_PRINT_LOGS" = "true" ]; then
  OPENCOD_OPTS="$OPENCOD_OPTS --print-logs"
fi

# Custom command configuration
RALPH_COMMAND="${RALPH_COMMAND:-}"
RALPH_BACKEND="${RALPH_BACKEND:-}"
RALPH_MODE="${RALPH_MODE:-autonomous}"

# Memory management to prevent OOM kills (exit code 137)
# Uses RALPH_MEMORY_LIMIT env var (default: 2GB = 2097152 KB)
if command -v ulimit &> /dev/null && [ -n "$RALPH_MEMORY_LIMIT" ]; then
  ulimit -v "$RALPH_MEMORY_LIMIT" 2>/dev/null || true
  ulimit -m "$RALPH_MEMORY_LIMIT" 2>/dev/null || true
fi

# Cleanup temp files on exit
trap 'rm -f /tmp/ralph_output_*.txt /tmp/ralph_validation_*.txt 2>/dev/null' EXIT

# Handle custom command mode
handle_custom_command() {
  if [[ -n "$RALPH_COMMAND" ]]; then
    echo "========================================"
    echo "üîß Custom Command Mode: $RALPH_COMMAND"
    echo "========================================"
    echo "  Backend: ${RALPH_BACKEND:-default}"
    echo "  Mode: $RALPH_MODE"
    echo "========================================"

    # Export backend and mode for the agent
    export RALPH_BACKEND="$RALPH_BACKEND"
    export RALPH_MODE="$RALPH_MODE"
  fi
}

# Load backend configuration if available
load_backend_config() {
  if [[ -n "$RALPH_BACKEND" ]]; then
    local backend_config="${BACKENDS_DIR}/${RALPH_BACKEND}/config.json"
    if [[ -f "$backend_config" ]]; then
      echo "üì¶ Loading backend configuration: $RALPH_BACKEND"

      # Load backend-specific settings if jq is available
      if command -v jq &> /dev/null; then
        local backend_enabled
        backend_enabled=$(jq -r '.enabled // false' "$backend_config" 2>/dev/null || echo "false")

        if [[ "$backend_enabled" == "true" ]]; then
          echo "‚úÖ Backend '$RALPH_BACKEND' enabled and configured"
        else
          echo "‚ö†Ô∏è Backend '$RALPH_BACKEND' is disabled in configuration"
        fi
      fi
    else
      echo "‚ö†Ô∏è Backend configuration not found: $backend_config"
    fi
  fi
}

# Initialize custom command support
handle_custom_command
load_backend_config

# Display configuration info
display_config() {
  echo "========================================"
  echo "‚öôÔ∏è  RalphLoop Configuration"
  echo "========================================"
  echo "  Timeout:        ${RALPH_TIMEOUT}s ($(($RALPH_TIMEOUT / 60)) minutes)"
  echo "  Memory Limit:   ${RALPH_MEMORY_LIMIT}KB ($(($RALPH_MEMORY_LIMIT / 1024 / 1024))GB)"
  echo "  Log Level:      $RALPH_LOG_LEVEL"
  echo "  Print Logs:     $RALPH_PRINT_LOGS"
  echo "  Max Iterations: $MAX_ROUNDS"
  if [ -n "$RALPH_BACKEND" ]; then
    echo "  Backend:        $RALPH_BACKEND"
    echo "  Mode:           $RALPH_MODE"
  fi
  echo "========================================"
}
display_config

# Validate MAX_ROUNDS is a positive integer
validate_max_rounds() {
  if ! [[ "$MAX_ROUNDS" =~ ^[0-9]+$ ]]; then
    echo "Error: MAX_ROUNDS must be a positive integer, got: '$MAX_ROUNDS'" >&2
    exit 1
  fi
  if [ "$MAX_ROUNDS" -eq 0 ]; then
    echo "Error: MAX_ROUNDS must be greater than 0" >&2
    exit 1
  fi
}
validate_max_rounds

# Determine prompt source
get_prompt() {
  # Priority 1: RALPH_PROMPT environment variable
  if [ -n "${RALPH_PROMPT:-}" ]; then
    echo "$RALPH_PROMPT"
    return
  fi

  # Priority 2: RALPH_PROMPT_FILE environment variable
  if [ -n "${RALPH_PROMPT_FILE:-}" ]; then
    if [ ! -f "$RALPH_PROMPT_FILE" ]; then
      echo "Error: RALPH_PROMPT_FILE points to a missing file: '$RALPH_PROMPT_FILE'" >&2
      exit 1
    fi
    cat "$RALPH_PROMPT_FILE"
    return
  fi

  # Priority 3: Default prompt.md file
  if [ ! -f "$PROMPT_FILE" ]; then
    echo "Error: No prompt file found." >&2
    echo "" >&2
    echo "To fix this, either:" >&2
    echo "  1. Create a 'prompt.md' file in the current directory" >&2
    echo "  2. Set RALPH_PROMPT environment variable with your objective" >&2
    echo "  3. Set RALPH_PROMPT_FILE to point to a valid prompt file" >&2
    exit 1
  fi
  cat "$PROMPT_FILE"
}

# Sanitize content to prevent heredoc injection
sanitize_for_heredoc() {
  local content="$1"
  echo "$content" | sed 's/EOF/RALPH_SAFE_EOF_MARKER/g'
}

# Get validation status from result
get_validation_status() {
  local result="$1"
  echo "$result" | grep -o '<validation_status>[^<]*</validation_status>' | sed 's/<[^>]*>//g' | tr -d ' '
}

# Get validation issues from result
get_validation_issues() {
  local result="$1"
  # Extract content between <validation_issues> and </validation_issues>
  local issues
  issues=$(echo "$result" | sed -n '/<validation_issues>/,/<\/validation_issues>/p' | sed '1d;$d')
  echo "$issues"
}

# Get validation recommendations from result
get_validation_recommendations() {
  local result="$1"
  # Extract content between <validation_recommendations> and </validation_recommendations>
  local recs
  recs=$(echo "$result" | sed -n '/<validation_recommendations>/,/<\/validation_recommendations>/p' | sed '1d;$d')
  echo "$recs"
}

# Ensure progress file exists
if [ ! -f "$PROGRESS_FILE" ]; then
  touch "$PROGRESS_FILE"
fi

# Clear previous validation issues at start
rm -f "$VALIDATION_ISSUES_FILE"

# Main loop
for ((i = 1; i <= MAX_ROUNDS; i++)); do
  echo "========================================"
  echo "üîÑ RalphLoop Iteration $i of $MAX_ROUNDS"
  echo "========================================"

  # Read current progress and prompt
  PROGRESS_CONTENT=$(cat "$PROGRESS_FILE")
  PROMPT_CONTENT=$(get_prompt)

  # Sanitize content to prevent heredoc injection
  SANITIZED_PROGRESS=$(sanitize_for_heredoc "$PROGRESS_CONTENT")
  SANITIZED_PROMPT=$(sanitize_for_heredoc "$PROMPT_CONTENT")

  # Check for pending validation issues from previous incomplete validation
  PENDING_ISSUES=""
  if [ -f "$VALIDATION_ISSUES_FILE" ]; then
    PENDING_ISSUES=$(cat "$VALIDATION_ISSUES_FILE")
  fi

  # Build context section with pending issues if any
  CONTEXT_SECTION=""
  if [ -n "$PENDING_ISSUES" ]; then
    CONTEXT_SECTION="
## üö® PENDING VALIDATION ISSUES FROM PREVIOUS ITERATION
The previous completion attempt failed validation. You MUST fix these issues:

${PENDING_ISSUES}

## Your Priority
Focus ONLY on resolving these validation issues. Do NOT work on new features.
After fixing, mark complete with <promise>COMPLETE</promise> for re-validation.
"
  fi

  # Build backend context section if using custom backend
  BACKEND_CONTEXT=""
  if [ -n "$RALPH_BACKEND" ]; then
    BACKEND_CONTEXT="
## üîß Backend Configuration

**Active Backend**: ${RALPH_BACKEND}
**Evaluation Mode**: ${RALPH_MODE}
**Custom Command**: ${RALPH_COMMAND:-none}

This iteration is running with backend integration. Be aware of any backend-specific requirements or constraints.
"
  fi

  # Run OpenCode agent with current context - capture output to file to avoid truncation
  # Timeout controlled by RALPH_TIMEOUT (default: 600 seconds)
  OUTPUT_FILE="/tmp/ralph_output_$$.txt"
  
  timeout "$RALPH_TIMEOUT" opencode run $OPENCOD_OPTS --agent AGENT_RALPH <<RALPH_EOF_XYZ123 > "$OUTPUT_FILE" 2>&1
# Goals and Resources

## Project plan

${SANITIZED_PROMPT}

## Current Progress

${SANITIZED_PROGRESS}
${CONTEXT_SECTION}
${BACKEND_CONTEXT}

## Your Priorities

### Phase 1: ANALYZE
1. [ ] Read and understand the project plan and acceptance criteria
2. [ ] Read progress.md to understand current state
3. [ ] Identify the highest priority next step that makes measurable progress

### Phase 2: PLAN & VALIDATE
4. [ ] Break down the goal into verifiable tasks
5. [ ] Define what "done" looks like for each task
6. [ ] Identify how you will verify completion (builds, tests, manual checks)

### Phase 3: EXECUTE & VERIFY
7. [ ] Implement the task
8. [ ] Run verification checks:
   - [ ] Code compiles/builds without errors
   - [ ] Tests pass (if applicable)
   - [ ] No linting errors
   - [ ] Changes meet acceptance criteria
9. [ ] Fix any issues found before proceeding

### Phase 4: DOCUMENT & COMMIT
10. [ ] Update progress.md with accomplishments
11. [ ] Create meaningful git commit
12. [ ] Identify next improvements

## Verification Requirements

BEFORE marking a task complete, you MUST verify:

- [ ] **Build**: Code compiles/runs successfully
- [ ] **Tests**: Unit tests pass (or state why not applicable)
- [ ] **Linting**: Code passes style checks
- [ ] **Requirements**: Feature meets acceptance criteria
- [ ] **Integration**: Works with existing code
- [ ] **No Regressions**: Existing functionality intact

## Constraints

- [ ] Only work on ONE goal per iteration
- [ ] NEVER skip verification steps
- [ ] Always run tests before committing

## Success Criteria

The loop succeeds when:

- [ ] Git history shows regular commits
- [ ] Progress tracking is current
- [ ] Verification checklist is completed
- [ ] Measurable progress made toward goal

If the current goal is complete, output <promise>COMPLETE</promise>.
RALPH_EOF_XYZ123

  EXIT_CODE=$?
  
  # Check if timeout or error occurred
  if [ $EXIT_CODE -eq 124 ]; then
    echo "‚ùå TIMEOUT: opencode command exceeded ${RALPH_TIMEOUT}s ($(($RALPH_TIMEOUT / 60)) minutes) - killed to prevent memory issues" >> "$OUTPUT_FILE"
    echo "This may indicate the agent is stuck or consuming too much memory." >> "$OUTPUT_FILE"
    echo "üí° Tip: Increase timeout with: export RALPH_TIMEOUT=$((RALPH_TIMEOUT * 2))" >> "$OUTPUT_FILE"
  elif [ $EXIT_CODE -ne 0 ]; then
    echo "‚ùå ERROR: opencode command failed with exit code $EXIT_CODE" >> "$OUTPUT_FILE"
  fi

  result=$(cat "$OUTPUT_FILE")
  
  # Check if result is empty or indicates an error
  if [ -z "$result" ]; then
    echo "‚ö†Ô∏è WARNING: Empty output from opencode agent - may indicate memory or execution issue"
    echo "Continuing to next iteration..."
    echo ""
    continue
  fi
  
  echo "$result"
  rm -f "$OUTPUT_FILE"

  # Check for completion
  if echo "$result" | grep -q "<promise>COMPLETE</promise>"; then
    echo ""
    echo "üõ°Ô∏è Goal marked complete. Running independent validation..."
    echo "========================================"

    # Run validation prompt to verify completion criteria are truly met - capture to file
    # Timeout controlled by RALPH_TIMEOUT (default: 600 seconds)
    VALIDATION_OUTPUT_FILE="/tmp/ralph_validation_$$.txt"
    
    timeout "$RALPH_TIMEOUT" opencode run $OPENCOD_OPTS --agent AGENT_RALPH <<RALPH_VALIDATE_EOF > "$VALIDATION_OUTPUT_FILE" 2>&1
# Validation Task

The agent previously indicated completion with <promise>COMPLETE</promise>.

You must INDEPENDENTLY VERIFY that all acceptance criteria are actually met.

## Original Project Goal (from prompt.md):
$(get_prompt)

## Current Progress:
$(cat "$PROGRESS_FILE")

## Backend Context (if applicable):
#if [ -n "$RALPH_BACKEND" ]; then
**Backend**: ${RALPH_BACKEND}
**Mode**: ${RALPH_MODE}
**Custom Command**: ${RALPH_COMMAND:-none}
#end if

## Your Validation Task:

1. READ the current codebase state
2. CHECK each acceptance criterion is actually satisfied:
   - For each requirement, verify it exists and works
   - Run tests, build commands, and manual checks
3. VERIFY git history shows meaningful commits
4. RUN comprehensive verification:
   - [ ] Code compiles/builds without errors (run: npm run build or equivalent)
   - [ ] Tests pass (run: npm test or equivalent)
   - [ ] No linting errors (run: npm run lint or equivalent)
   - [ ] All acceptance criteria from prompt.md are met
   - [ ] No regressions in existing functionality
5. OUTPUT your findings in this exact XML format:

<validation_status>PASS</validation_status> or <validation_status>FAIL</validation_status>

<validation_issues>
- [List each failing criterion with specific details]
- Leave empty if PASS
</validation_issues>

<validation_recommendations>
- [Specific actions needed to fix each issue]
- Leave empty if PASS
</validation_recommendations>

IMPORTANT:
- If ALL checks pass, use <validation_status>PASS</validation_status>
- If ANY check fails, use <validation_status>FAIL</validation_status> and list all issues
- Do NOT trust the previous agent's assessment. Verify independently.
RALPH_VALIDATE_EOF

    VALIDATION_EXIT_CODE=$?
    
    # Check if timeout or error occurred
    if [ $VALIDATION_EXIT_CODE -eq 124 ]; then
      echo "‚ùå VALIDATION TIMEOUT: exceeded ${RALPH_TIMEOUT}s ($(($RALPH_TIMEOUT / 60)) minutes)" >> "$VALIDATION_OUTPUT_FILE"
      echo "<validation_status>FAIL</validation_status>" >> "$VALIDATION_OUTPUT_FILE"
      echo "<validation_issues>" >> "$VALIDATION_OUTPUT_FILE"
      echo "- Validation timed out after ${RALPH_TIMEOUT}s ($(($RALPH_TIMEOUT / 60)) minutes)" >> "$VALIDATION_OUTPUT_FILE"
      echo "- Increase timeout with: export RALPH_TIMEOUT=$((RALPH_TIMEOUT * 2))" >> "$VALIDATION_OUTPUT_FILE"
      echo "</validation_issues>" >> "$VALIDATION_OUTPUT_FILE"
    elif [ $VALIDATION_EXIT_CODE -ne 0 ]; then
      echo "‚ùå VALIDATION ERROR: failed with exit code $VALIDATION_EXIT_CODE" >> "$VALIDATION_OUTPUT_FILE"
    fi

    validation_result=$(cat "$VALIDATION_OUTPUT_FILE")
    rm -f "$VALIDATION_OUTPUT_FILE"

    echo ""
    echo "üìã Validation Results:"
    echo "-----------------------------------"
    echo "$validation_result"
    echo "-----------------------------------"

    # Extract and check validation status
    VALIDATION_STATUS=$(get_validation_status "$validation_result")

    if [ "$VALIDATION_STATUS" = "PASS" ]; then
      echo ""
      echo "üéâ Validation PASSED! RalphLoop mission complete!"
      echo "========================================"
      rm -f "$VALIDATION_ISSUES_FILE"
      exit 0
    else
      echo ""
      echo "‚ö†Ô∏è Validation FAILED. Saving issues for next iteration..."
      # Extract and save validation issues
      ISSUES=$(get_validation_issues "$validation_result")
      RECOMMENDATIONS=$(get_validation_recommendations "$validation_result")

      # Combine issues and recommendations for the next iteration
      {
        echo "## Issues Found:"
        echo "$ISSUES"
        echo ""
        echo "## Recommendations:"
        echo "$RECOMMENDATIONS"
      } >"$VALIDATION_ISSUES_FILE"

      echo "Issues saved to ${VALIDATION_ISSUES_FILE}"
      echo "Agent will prioritize fixing these in next iteration."
      echo ""
    fi
  fi

  echo ""
  echo "‚úÖ Iteration $i complete. Continuing..."
  echo ""
done

echo "========================================"
echo "üèÅ Max iterations ($MAX_ROUNDS) reached."
echo "   RalphLoop will rest for now."
echo "========================================"
