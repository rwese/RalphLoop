#!/usr/bin/env bash

# ralph - RalphLoop Autonomous Development Agent
# Usage: ./ralph <iterations>
#
# Prompt can be provided via:
# 1. prompt.md file (default)
# 2. RALPH_PROMPT environment variable (direct prompt text)
# 3. RALPH_PROMPT_FILE environment variable (path to prompt file)

set -e -u -o pipefail

# Configuration
MAX_ROUNDS=${1:-100}
PROGRESS_FILE="progress.md"
PROMPT_FILE="prompt.md"

# Determine prompt source
get_prompt() {
  # Priority 1: RALPH_PROMPT environment variable
  if [ -n "${RALPH_PROMPT:-}" ]; then
    echo "$RALPH_PROMPT"
    return
  fi

  # Priority 2: RALPH_PROMPT_FILE environment variable
  if [ -n "${RALPH_PROMPT_FILE:-}" ]; then
    [ -f "$RALPH_PROMPT_FILE" ] || {
      echo "Error: RALPH_PROMPT_FILE '$RALPH_PROMPT_FILE' not found" >&2
      exit 1
    }
    cat "$RALPH_PROMPT_FILE"
    return
  fi

  # Priority 3: Default prompt.md file
  [ -f "$PROMPT_FILE" ] || {
    echo "Error: $PROMPT_FILE file must exist (or set RALPH_PROMPT/RALPH_PROMPT_FILE)" >&2
    exit 1
  }
  cat "$PROMPT_FILE"
}

# Ensure progress file exists
if [ ! -f "$PROGRESS_FILE" ]; then
  touch "$PROGRESS_FILE"
fi

# Main loop
for ((i = 1; i <= MAX_ROUNDS; i++)); do
  echo "========================================"
  echo "üîÑ RalphLoop Iteration $i of $MAX_ROUNDS"
  echo "========================================"

  # Read current progress and prompt
  PROGRESS_CONTENT=$(cat "$PROGRESS_FILE")
  PROMPT_CONTENT=$(get_prompt)

  # Run OpenCode agent with current context
  result=$(
    opencode run --share --agent AGENT_RALPH <<EOF
# Goals and Resources

## Project plan

${PROMPT_CONTENT}

## Current Progress

${PROGRESS_CONTENT}

## Your Priorities

1. [ ] Analyze current state and decide highest goal next step
2. [ ] Work on the next goal
3. [ ] Update progress.md with what was accomplished and which goals are left to reach our project plan
4. [ ] Create git commit with changes
5. [ ] Identify new improvements or features to add to achieve our goal

## Constraints

- [ ] Only work on ONE goal per iteration

## Success Criteria

The loop succeeds when:

- [ ] Git history shows regular commits
- [ ] Progress tracking is up to date
- [ ] We made progress towards our goal

If the current goal is complete, output <promise>COMPLETE</promise>.
EOF
  )

  echo "$result" | tee /dev/stderr

  # Check for completion
  if echo "$result" | grep -q "<promise>COMPLETE</promise>"; then
    echo ""
    echo "üéâ RalphLoop mission complete!"
    echo "========================================"
    exit 0
  fi

  echo ""
  echo "‚úÖ Iteration $i complete. Continuing..."
  echo ""
done

echo "========================================"
echo "üèÅ Max iterations ($MAX_ROUNDS) reached."
echo "   RalphLoop will rest for now."
echo "========================================"
